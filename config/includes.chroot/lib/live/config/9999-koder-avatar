#!/bin/sh
# Set Koder icon as user avatar on GDM login screen

LIVE_USERNAME="${LIVE_USERNAME:-user}"
AVATAR="/var/lib/AccountsService/icons/koder-avatar.png"

if [ ! -f "$AVATAR" ]; then
    # Generate avatar from SVG: render icon at 64px centered on 96px transparent canvas
    if command -v rsvg-convert > /dev/null 2>&1 && command -v convert > /dev/null 2>&1; then
        rsvg-convert /usr/share/koder-linux/koder_icon.svg -w 64 -h 64 -o /tmp/koder-avatar-small.png 2>/dev/null
        convert /tmp/koder-avatar-small.png -gravity center -background none -extent 96x96 "$AVATAR" 2>/dev/null || true
        rm -f /tmp/koder-avatar-small.png
    elif command -v rsvg-convert > /dev/null 2>&1; then
        rsvg-convert /usr/share/koder-linux/koder_icon.svg -w 64 -h 64 -o "$AVATAR" 2>/dev/null || true
    fi
fi

if [ -f "$AVATAR" ]; then
    mkdir -p /var/lib/AccountsService/users
    cat > "/var/lib/AccountsService/users/${LIVE_USERNAME}" << EOF
[User]
Icon=${AVATAR}
EOF
fi
